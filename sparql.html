<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARQL Query | SHACL Demo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ”—</text></svg>">
    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --accent: #38bdf8;
            --border: #334155;
            --mono: 'Fira Code', monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* â”€â”€ Header â”€â”€ */
        header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }

        .header-main { flex-shrink: 0; }

        h1 {
            margin: 0 0 8px 0;
            font-weight: 300;
            font-size: 1.25rem;
            line-height: 1.2;
        }

        .meta {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 8px;
        }

        .badge {
            background: #334155;
            color: #94a3b8;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-links {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
            flex-shrink: 0;
            text-align: right;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .nav-links a {
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.2s;
        }

        .nav-links a:hover { color: var(--accent); }
        .nav-links a.active { color: var(--accent); }

        /* â”€â”€ Status dot â”€â”€ */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .dot-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .dot-indicator.online {
            background: #10b981;
            box-shadow: 0 0 5px #10b981;
        }

        /* â”€â”€ Main layout â”€â”€ */
        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* â”€â”€ Sidebar â”€â”€ */
        .left-panel {
            width: 280px;
            flex-shrink: 0;
            background: var(--bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            gap: 1.2rem;
            overflow-y: auto;
        }

        .section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .section label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Stats */
        .status-dashboard {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
        }

        .api-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .api-row .label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            text-align: center;
        }

        .stat-item strong {
            font-size: 1.1rem;
            color: var(--text);
            display: block;
            transition: color 0.2s;
        }

        .stat-item small {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .stat-item:hover strong { color: var(--accent); }

        /* Example buttons */
        .example-btn {
            background: #020617;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            color: var(--text-muted);
            font-family: var(--mono);
            font-size: 0.72rem;
            cursor: pointer;
            text-align: left;
            transition: all 0.15s;
            line-height: 1.4;
            width: 100%;
        }

        .example-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .example-btn .ex-label {
            display: block;
            font-weight: 700;
            margin-bottom: 0.15rem;
            font-size: 0.72rem;
            color: var(--text);
            font-family: system-ui, sans-serif;
        }

        .example-btn:hover .ex-label { color: var(--accent); }

        /* â”€â”€ Right panel â”€â”€ */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg);
        }

        /* Toolbar */
        .editor-toolbar {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .limit-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .limit-input {
            background: #020617;
            border: 1px solid var(--border);
            color: var(--text);
            font-family: var(--mono);
            font-size: 0.75rem;
            padding: 0.35rem 0.5rem;
            border-radius: 5px;
            width: 70px;
            text-align: center;
        }

        .limit-input:focus { outline: none; border-color: var(--accent); }

        .shortcut-hint {
            margin-left: auto;
            font-size: 0.65rem;
            color: var(--text-muted);
            font-family: var(--mono);
        }

        /* Buttons */
        button {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            min-height: 36px;
        }

        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary {
            background: #38bdf8;
            color: #0f172a;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-secondary:hover { background: #334155; }

        .btn-export {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            border-radius: 5px;
            padding: 0.25rem 0.6rem;
            font-family: var(--mono);
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.15s;
            min-height: unset;
        }

        .btn-export:hover { border-color: #10b981; color: #10b981; }

        /* Editor */
        textarea#queryEditor {
            flex: 1;
            background: #020617;
            border: none;
            color: #a5b4fc;
            font-family: var(--mono);
            font-size: 0.82rem;
            padding: 1rem 1.25rem;
            resize: none;
            line-height: 1.7;
            outline: none;
            min-height: 160px;
        }

        /* Results */
        .results-panel {
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            min-height: 180px;
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.4rem 1rem;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .results-meta {
            font-family: var(--mono);
            font-size: 0.65rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .results-meta .count { color: #10b981; font-weight: 700; }
        .results-meta .timing { color: var(--accent); }

        .results-table-wrap { flex: 1; overflow: auto; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--mono);
            font-size: 0.75rem;
        }

        thead th {
            background: var(--panel);
            color: var(--text-muted);
            font-weight: 700;
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            letter-spacing: 0.05em;
            font-size: 0.65rem;
            text-transform: uppercase;
        }

        tbody tr { border-bottom: 1px solid rgba(51,65,85,0.4); }
        tbody tr:hover { background: rgba(56,189,248,0.03); }

        tbody td {
            padding: 0.45rem 0.75rem;
            color: var(--text);
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        tbody td.iri { color: var(--accent); font-size: 0.7rem; }
        tbody td.literal { color: #86efac; }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 0.5rem;
            color: var(--text-muted);
            font-size: 0.8rem;
            opacity: 0.6;
        }

        .error-state {
            padding: 1rem;
            color: #ef4444;
            font-family: var(--mono);
            font-size: 0.75rem;
            background: rgba(239,68,68,0.05);
            border: 1px solid rgba(239,68,68,0.2);
            border-radius: 6px;
            margin: 1rem;
            white-space: pre-wrap;
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Spinner */
        .spinner {
            width: 14px; height: 14px;
            border: 2px solid rgba(15,23,42,0.3);
            border-top-color: #0f172a;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .small { padding: 0.3rem 0.6rem; font-size: 0.75rem; }
    </style>
</head>
<body>

<header>
    <div class="header-main">
        <h1>SPARQL Query</h1>
        <div class="meta">
            <span class="badge">Token Graph</span>
            <span style="font-size:0.75rem;color:var(--text-muted);font-family:var(--mono);">http://shacl-demo.org/token</span>
        </div>
    </div>
    <div class="nav-links">
        <a href="index.html">Instance Creation</a> |
        <a href="index.html">Template Generation</a> |
        <a href="index.html">SHACL Inference</a> |
        <a href="index.html">SHACL Validation</a> |
        <a href="sparql.html" class="active">SPARQL Query</a>
    </div>
</header>

<div class="main">

    <!-- Sidebar -->
    <div class="left-panel">

        <div class="status-dashboard">
            <div class="api-row">
                <span class="label">Token Graph</span>
                <div class="status-indicator">
                    <span class="dot-indicator" id="statusDot"></span>
                    <span id="statusText" style="font-size:0.8rem;font-weight:600;">Connecting...</span>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-item"><strong id="countTokens">â€”</strong><small>Tokens</small></div>
                <div class="stat-item"><strong id="countTriples">â€”</strong><small>Triples</small></div>
                <div class="stat-item"><strong id="countTypes">â€”</strong><small>Types</small></div>
                <div class="stat-item"><strong id="countProps">â€”</strong><small>Properties</small></div>
            </div>
        </div>

        <div class="section">
            <label>Example Queries</label>
            <button class="example-btn" onclick="loadExample('all')">
                <span class="ex-label">All Tokens</span>
                Browse everything in the token graph
            </button>
            <button class="example-btn" onclick="loadExample('byType')">
                <span class="ex-label">Tokens by Type</span>
                Group instances by situation class
            </button>
            <button class="example-btn" onclick="loadExample('inferred')">
                <span class="ex-label">Inferred Relations</span>
                Opaque properties from SHACL rules
            </button>
            <button class="example-btn" onclick="loadExample('entities')">
                <span class="ex-label">Named Entities</span>
                All Entity instances with labels
            </button>
            <button class="example-btn" onclick="loadExample('timeline')">
                <span class="ex-label">Situation Chain</span>
                Situations connected by shared participants
            </button>
            <button class="example-btn" onclick="loadExample('lemmas')">
                <span class="ex-label">Verbs Used</span>
                Unique verb lemmas in the token graph
            </button>
        </div>

    </div>

    <!-- Editor + Results -->
    <div class="right-panel">

        <div class="editor-toolbar">
            <button class="btn-primary" id="runBtn" onclick="runQuery()">â–¶ Run Query</button>
            <button class="btn-secondary small" onclick="clearEditor()">Clear</button>
            <span class="limit-label">Limit</span>
            <input class="limit-input" type="number" id="limitInput" value="100" min="1" max="10000">
            <span class="shortcut-hint">âŒ˜â†µ to run</span>
        </div>

        <textarea id="queryEditor" spellcheck="false" placeholder="Enter SPARQL SELECT query..."></textarea>

        <div class="results-panel">
            <div class="results-header">
                <div class="results-meta">
                    <span id="resultCount"></span>
                    <span id="resultTiming"></span>
                </div>
                <button class="btn-export" id="exportBtn" onclick="exportCSV()" style="display:none">â†“ Export CSV</button>
            </div>
            <div class="results-table-wrap" id="resultsArea">
                <div class="empty-state">
                    <span>Run a query to see results</span>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
const SPARQL_ENDPOINT = "http://localhost:8890/sparql";
const TOKEN_GRAPH     = "http://shacl-demo.org/token";
const ONT_NS          = "https://falcontologist.github.io/shacl-demo/ontology/";
const TEMP_NS         = "https://falcontologist.github.io/shacl-demo/temp/";

const EXAMPLES = {
    all: `SELECT ?subject ?predicate ?object\nWHERE {\n  GRAPH <${TOKEN_GRAPH}> {\n    ?subject ?predicate ?object .\n  }\n}\nORDER BY ?subject`,
    byType: `SELECT ?type (COUNT(?token) AS ?count)\nWHERE {\n  GRAPH <${TOKEN_GRAPH}> {\n    ?token a ?type .\n  }\n}\nGROUP BY ?type\nORDER BY DESC(?count)`,
    inferred: `SELECT ?subject ?verb ?object\nWHERE {\n  GRAPH <${TOKEN_GRAPH}> {\n    ?subject ?verb ?object .\n    FILTER(CONTAINS(STR(?verb), "${ONT_NS}"))\n    FILTER(REGEX(STR(?verb), "_[a-f0-9]{12}$"))\n  }\n}`,
    entities: `SELECT ?entity ?label\nWHERE {\n  GRAPH <${TOKEN_GRAPH}> {\n    ?entity a <${ONT_NS}Entity> ;\n            <http://www.w3.org/2000/01/rdf-schema#label> ?label .\n  }\n}\nORDER BY ?label`,
    timeline: `SELECT ?s1label ?predicate ?s2label\nWHERE {\n  GRAPH <${TOKEN_GRAPH}> {\n    ?s1 a ?type1 ; <http://www.w3.org/2000/01/rdf-schema#label> ?s1label .\n    ?s2 a ?type2 ; <http://www.w3.org/2000/01/rdf-schema#label> ?s2label .\n    ?s1 ?predicate ?s2 .\n    FILTER(?s1 != ?s2)\n    FILTER(STRSTARTS(STR(?s1), "${TEMP_NS}s"))\n    FILTER(STRSTARTS(STR(?s2), "${TEMP_NS}s"))\n  }\n}`,
    lemmas: `SELECT DISTINCT ?lemma (COUNT(?token) AS ?count)\nWHERE {\n  GRAPH <${TOKEN_GRAPH}> {\n    ?token <${ONT_NS}lemma> ?lemma .\n  }\n}\nGROUP BY ?lemma\nORDER BY DESC(?count)`
};

let lastResults = [];

document.addEventListener('DOMContentLoaded', () => {
    loadExample('all');
    checkConnection();
    loadStats();
    document.getElementById('queryEditor').addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            runQuery();
        }
    });
});

function loadExample(key) {
    document.getElementById('queryEditor').value = EXAMPLES[key];
}

function clearEditor() {
    document.getElementById('queryEditor').value = '';
    document.getElementById('resultsArea').innerHTML = '<div class="empty-state"><span>Run a query to see results</span></div>';
    document.getElementById('resultCount').textContent = '';
    document.getElementById('resultTiming').textContent = '';
    document.getElementById('exportBtn').style.display = 'none';
    lastResults = [];
}

async function checkConnection() {
    try {
        const url = `${SPARQL_ENDPOINT}?query=${encodeURIComponent('ASK { }')}&format=json`;
        const r = await fetch(url);
        if (r.ok) {
            document.getElementById('statusDot').classList.add('online');
            document.getElementById('statusText').textContent = 'Connected';
        } else throw new Error();
    } catch {
        document.getElementById('statusText').textContent = 'Offline';
    }
}

async function loadStats() {
    const queries = {
        countTokens: `SELECT (COUNT(DISTINCT ?s) AS ?n) WHERE { GRAPH <${TOKEN_GRAPH}> { ?s a ?t . FILTER(STRSTARTS(STR(?s), "${TEMP_NS}s")) } }`,
        countTriples: `SELECT (COUNT(*) AS ?n) WHERE { GRAPH <${TOKEN_GRAPH}> { ?s ?p ?o } }`,
        countTypes:   `SELECT (COUNT(DISTINCT ?t) AS ?n) WHERE { GRAPH <${TOKEN_GRAPH}> { ?s a ?t } }`,
        countProps:   `SELECT (COUNT(DISTINCT ?p) AS ?n) WHERE { GRAPH <${TOKEN_GRAPH}> { ?s ?p ?o } }`
    };
    for (const [id, q] of Object.entries(queries)) {
        try {
            const r = await fetch(`${SPARQL_ENDPOINT}?query=${encodeURIComponent(q)}&format=json`);
            const data = await r.json();
            document.getElementById(id).textContent = data.results.bindings[0]?.n?.value ?? 'â€”';
        } catch {}
    }
}

async function runQuery() {
    const btn = document.getElementById('runBtn');
    const editor = document.getElementById('queryEditor');
    const resultsArea = document.getElementById('resultsArea');
    let query = editor.value.trim();
    if (!query) return;

    const limit = parseInt(document.getElementById('limitInput').value) || 100;
    if (!/LIMIT\s+\d+/i.test(query)) query += `\nLIMIT ${limit}`;

    btn.innerHTML = '<span class="spinner"></span> Runningâ€¦';
    btn.disabled = true;
    resultsArea.innerHTML = '<div class="empty-state"><span>Executingâ€¦</span></div>';
    document.getElementById('resultCount').textContent = '';
    document.getElementById('resultTiming').textContent = '';
    document.getElementById('exportBtn').style.display = 'none';

    const t0 = performance.now();
    try {
        const r = await fetch(`${SPARQL_ENDPOINT}?query=${encodeURIComponent(query)}&format=json`);
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();
        const elapsed = ((performance.now() - t0) / 1000).toFixed(2);
        renderResults(data, elapsed);
        loadStats();
    } catch (err) {
        resultsArea.innerHTML = `<div class="error-state">âš  Query failed:\n\n${err.message}</div>`;
    } finally {
        btn.innerHTML = 'â–¶ Run Query';
        btn.disabled = false;
    }
}

function renderResults(data, elapsed) {
    const resultsArea = document.getElementById('resultsArea');
    const vars = data.head.variables;
    const bindings = data.results.bindings;
    lastResults = bindings;

    const count = bindings.length;
    document.getElementById('resultCount').innerHTML = `<span class="count">${count} row${count !== 1 ? 's' : ''}</span>`;
    document.getElementById('resultTiming').innerHTML = `<span class="timing">${elapsed}s</span>`;

    if (count === 0) {
        resultsArea.innerHTML = '<div class="empty-state"><span>No results</span></div>';
        return;
    }

    document.getElementById('exportBtn').style.display = 'block';

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const hr = document.createElement('tr');
    vars.forEach(v => { const th = document.createElement('th'); th.textContent = v; hr.appendChild(th); });
    thead.appendChild(hr);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    bindings.forEach(row => {
        const tr = document.createElement('tr');
        vars.forEach(v => {
            const td = document.createElement('td');
            const cell = row[v];
            if (!cell) { td.textContent = ''; }
            else if (cell.type === 'uri') { td.className = 'iri'; td.textContent = abbreviate(cell.value); td.title = cell.value; }
            else { td.className = 'literal'; td.textContent = cell.value; }
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    resultsArea.innerHTML = '';
    resultsArea.appendChild(table);
}

function abbreviate(iri) {
    if (iri.startsWith(ONT_NS))  return ':' + iri.slice(ONT_NS.length);
    if (iri.startsWith(TEMP_NS)) return 'temp:' + iri.slice(TEMP_NS.length);
    if (iri.startsWith('http://www.w3.org/1999/02/22-rdf-syntax-ns#')) return 'rdf:' + iri.slice(43);
    if (iri.startsWith('http://www.w3.org/2000/01/rdf-schema#')) return 'rdfs:' + iri.slice(37);
    return iri;
}

function exportCSV() {
    if (!lastResults.length) return;
    const vars = Object.keys(lastResults[0]);
    const rows = [vars.join(',')];
    lastResults.forEach(row => {
        rows.push(vars.map(v => `"${(row[v]?.value || '').replace(/"/g, '""')}"`).join(','));
    });
    const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'sparql-results.csv'; a.click();
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>
