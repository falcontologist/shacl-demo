<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARQL Query | SHACL Demo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ”—</text></svg>">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --accent: #38bdf8;
            --border: #334155;
            --col-class: #10b981;
            --col-instance: #f59e0b;
            --col-literal: #3b82f6;
            --mono: 'Fira Code', monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* â”€â”€ Header â”€â”€ */
        header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            overflow: hidden;
        }

        .header-main { flex-shrink: 0; }

        h1 {
            margin: 0 0 8px 0;
            font-weight: 300;
            font-size: 1.25rem;
            line-height: 1.2;
        }

        .meta {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 8px;
        }

        .badge {
            background: #334155;
            color: #94a3b8;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .source-link {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .source-link code {
            color: var(--accent);
            font-family: var(--mono);
        }

        .nav-links {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
            flex-shrink: 0;
            text-align: right;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .nav-links a {
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.2s;
        }

        .nav-links a:hover { color: var(--accent); }
        .nav-links a.active { color: var(--accent); }

        /* â”€â”€ Main split â”€â”€ */
        .split-view {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* â”€â”€ Left panel â”€â”€ */
        .left-panel {
            width: 420px;
            flex-shrink: 0;
            background: var(--bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            gap: 1.2rem;
            overflow-y: auto;
        }

        .section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .section > label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Stats dashboard */
        .status-dashboard {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
        }

        .api-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .api-row .label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .dot-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .dot-indicator.online {
            background: #10b981;
            box-shadow: 0 0 5px #10b981;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            text-align: center;
        }

        .stat-item strong {
            font-size: 1.1rem;
            color: var(--text);
            display: block;
            transition: color 0.2s;
        }

        .stat-item small {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .stat-item:hover strong { color: var(--accent); }

        /* Example buttons */
        .example-btn {
            background: #020617;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            color: var(--text-muted);
            font-family: var(--mono);
            font-size: 0.72rem;
            cursor: pointer;
            text-align: left;
            transition: all 0.15s;
            line-height: 1.4;
            width: 100%;
            min-height: unset;
        }

        .example-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .example-btn .ex-label {
            display: block;
            font-weight: 700;
            margin-bottom: 0.15rem;
            font-size: 0.72rem;
            color: var(--text);
            font-family: system-ui, sans-serif;
        }

        .example-btn:hover .ex-label { color: var(--accent); }

        /* Query editor */
        .editor-toolbar {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-shrink: 0;
        }

        .limit-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .limit-input {
            background: #020617;
            border: 1px solid var(--border);
            color: var(--text);
            font-family: var(--mono);
            font-size: 0.75rem;
            padding: 0.35rem 0.5rem;
            border-radius: 5px;
            width: 70px;
            text-align: center;
        }

        .limit-input:focus { outline: none; border-color: var(--accent); }

        .shortcut-hint {
            margin-left: auto;
            font-size: 0.65rem;
            color: var(--text-muted);
            font-family: var(--mono);
        }

        textarea#queryEditor {
            background: #020617;
            border: 1px solid var(--border);
            color: #a5b4fc;
            font-family: var(--mono);
            font-size: 0.8rem;
            padding: 0.75rem;
            resize: vertical;
            line-height: 1.7;
            outline: none;
            border-radius: 6px;
            height: 160px;
            width: 100%;
        }

        textarea#queryEditor:focus { border-color: var(--accent); }

        /* Results */
        .results-section {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            gap: 0.5rem;
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .results-meta {
            font-family: var(--mono);
            font-size: 0.65rem;
            color: var(--text-muted);
            display: flex;
            gap: 1rem;
        }

        .results-meta .count { color: #10b981; font-weight: 700; }
        .results-meta .timing { color: var(--accent); }

        .results-table-wrap {
            flex: 1;
            overflow: auto;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: #020617;
            min-height: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--mono);
            font-size: 0.75rem;
        }

        thead th {
            background: var(--panel);
            color: var(--text-muted);
            font-weight: 700;
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tbody tr { border-bottom: 1px solid rgba(51,65,85,0.4); }
        tbody tr:hover { background: rgba(56,189,248,0.03); }

        tbody td {
            padding: 0.45rem 0.75rem;
            color: var(--text);
            max-width: 320px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        tbody td.iri { color: var(--accent); font-size: 0.7rem; }
        tbody td.literal { color: #86efac; }

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 80px;
            color: var(--text-muted);
            font-size: 0.8rem;
            opacity: 0.6;
        }

        .error-state {
            padding: 1rem;
            color: #ef4444;
            font-family: var(--mono);
            font-size: 0.75rem;
            white-space: pre-wrap;
        }

        /* Buttons */
        button {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            min-height: 36px;
        }

        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary { background: #38bdf8; color: #0f172a; }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }

        .btn-secondary { background: var(--panel); border: 1px solid var(--border); color: var(--text); }
        .btn-secondary:hover { background: #334155; }

        .btn-export {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            border-radius: 5px;
            padding: 0.25rem 0.6rem;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.15s;
            min-height: unset;
            font-weight: 600;
        }

        .btn-export:hover { border-color: #10b981; color: #10b981; }

        .small { padding: 0.3rem 0.6rem; font-size: 0.75rem; min-height: unset; }

        /* â”€â”€ Right panel (D3 graph) â”€â”€ */
        .right-panel {
            flex: 1;
            background: #020617;
            position: relative;
            overflow: hidden;
        }

        #graph-container, #graph-container svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        .link {
            stroke: #334155;
            stroke-width: 2px;
            opacity: 0.6;
            fill: none;
        }

        .node-label-text, .link-label-text {
            font-size: 11px;
            fill: #e2e8f0;
            font-family: var(--mono);
            font-weight: bold;
            pointer-events: none;
            user-select: none;
        }

        .node-label-text { fill: #ffffff; font-size: 12px; }
        .link-label-text { fill: var(--accent); }

        .graph-overlay {
            position: absolute;
            bottom: 1.5rem;
            right: 1.5rem;
            pointer-events: none;
        }

        .legend {
            background: rgba(15,23,42,0.95);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 6px;
            backdrop-filter: blur(10px);
        }

        .legend div {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
        }

        .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .dot.subject  { background: #f59e0b; }
        .dot.object   { background: #38bdf8; }
        .dot.literal  { background: #3b82f6; }

        .zoom-hint {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: right;
            margin-top: 5px;
            opacity: 0.7;
        }

        .empty-graph {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.8rem;
            opacity: 0.4;
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .spinner {
            width: 14px; height: 14px;
            border: 2px solid rgba(15,23,42,0.3);
            border-top-color: #0f172a;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header>
    <div class="header-main">
        <h1>SPARQL Query</h1>
        <div class="meta">
            <span class="badge">Jena Â· Virtuoso</span>
            <span class="source-link">Source: <code>http://shacl-demo.org/token</code></span>
        </div>
    </div>
    <div class="nav-links">
        <a href="index.html">Instance Creation</a> |
        <a href="index.html">Template Generation</a> |
        <a href="index.html">SHACL Inference</a> |
        <a href="index.html">SHACL Validation</a> |
        <a href="sparql.html" class="active">SPARQL Query</a>
    </div>
</header>

<div class="split-view">

    <div class="left-panel">

        <div class="status-dashboard">
            <div class="api-row">
                <span class="label">Graph DB</span>
                <div class="status-indicator">
                    <span class="dot-indicator" id="statusDot"></span>
                    <span id="statusText">Connecting...</span>
                </div>
            </div>
            <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="stat-item"><strong id="countInstances">â€”</strong><small>Instances</small></div>
                <div class="stat-item"><strong id="countTriples">â€”</strong><small>Triples</small></div>
            </div>
        </div>

        <div class="section">
            <div class="editor-toolbar">
                <button class="btn-primary" id="runBtn" onclick="runQuery()">â–¶ Run</button>
                <button class="btn-secondary small" onclick="clearAll()">Clear</button>
                <span class="limit-label">Limit</span>
                <input class="limit-input" type="number" id="limitInput" value="100" min="1" max="10000">
                <span class="shortcut-hint">âŒ˜â†µ</span>
            </div>
            <textarea id="queryEditor" spellcheck="false" placeholder="Enter SPARQL SELECT query..."></textarea>
        </div>

        <div class="section">
            <label>Example Queries</label>
            <button class="example-btn" onclick="loadExample('nvidia')">
                <span class="ex-label">NVIDIA Acquisitions</span>
                Which companies did NVIDIA acquire?
            </button>
            <button class="example-btn" onclick="loadExample('bloomberg')">
                <span class="ex-label">Bloomberg Employment</span>
                What is Mike Bloomberg's employment history?
            </button>
        </div>

        <div class="results-section">
            <div class="results-header">
                <div class="results-meta">
                    <span id="resultCount"></span>
                    <span id="resultTiming"></span>
                </div>
                <button class="btn-export" id="exportBtn" onclick="exportCSV()" style="display:none">â†“ CSV</button>
            </div>
            <div class="results-table-wrap" id="resultsArea">
                <div class="empty-state">Run a query to see results</div>
            </div>
        </div>

    </div>

    <div class="right-panel">
        <div id="graph-container"></div>
        <div class="empty-graph" id="emptyGraph">Results will appear here as a graph</div>
        <div class="graph-overlay">
            <div class="legend">
                <div><span class="dot subject"></span> Subject</div>
                <div><span class="dot object"></span> Object (IRI)</div>
                <div><span class="dot literal"></span> Literal</div>
            </div>
            <div class="zoom-hint">Scroll to Zoom Â· Drag Nodes</div>
        </div>
    </div>

</div>

<script>
const API_BASE_URL = (window.location.hostname === 'localhost' ||
    window.location.hostname === '127.0.0.1' ||
    window.location.hostname === '')
    ? "http://localhost:8080/api"
    : "https://shacl-api-docker.onrender.com/api";

const SPARQL_ENDPOINT = API_BASE_URL + "/sparql";
const GRAPH_URI       = "http://shacl-demo.org/token";
const ONT_NS          = "https://falcontologist.github.io/shacl-demo/ontology/";
const TEMP_NS         = "https://falcontologist.github.io/shacl-demo/temp/";

const EXAMPLES = {
    nvidia: `# Which companies did NVIDIA acquire?
SELECT ?acquiredCompany
WHERE {
  GRAPH <${GRAPH_URI}> {
    ?s a <${ONT_NS}Acquisition> ;
       <${ONT_NS}acquirer> <${TEMP_NS}NVIDIA> ;
       <${ONT_NS}acquisition> ?targetNode .
    ?targetNode <http://www.w3.org/2000/01/rdf-schema#label> ?acquiredCompany .
  }
}`,
    bloomberg: `# What is Mike Bloomberg's employment history?
SELECT ?situation ?employer ?role
WHERE {
  GRAPH <${GRAPH_URI}> {
    ?situation <${ONT_NS}employee> <${TEMP_NS}Mike_Bloomberg> ;
               <http://www.w3.org/2000/01/rdf-schema#label> ?role .
    OPTIONAL {
      ?situation <${ONT_NS}employer> ?employerNode .
      ?employerNode <http://www.w3.org/2000/01/rdf-schema#label> ?employer .
    }
  }
}`
};

let lastResults = [];
let simulation, svg, g, zoom;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
    loadExample('all');
    checkConnection();
    loadStats();
    initGraph();
    document.getElementById('queryEditor').addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); runQuery(); }
    });
});

function loadExample(key) {
    document.getElementById('queryEditor').value = EXAMPLES[key];
}

function clearAll() {
    document.getElementById('queryEditor').value = '';
    document.getElementById('resultsArea').innerHTML = '<div class="empty-state">Run a query to see results</div>';
    document.getElementById('resultCount').textContent = '';
    document.getElementById('resultTiming').textContent = '';
    document.getElementById('exportBtn').style.display = 'none';
    document.getElementById('emptyGraph').style.display = 'flex';
    if (g) g.selectAll('*').remove();
    if (simulation) simulation.stop();
    lastResults = [];
}

// â”€â”€ Connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkConnection() {
    try {
        const url = `${SPARQL_ENDPOINT}?query=${encodeURIComponent('ASK { }')}`;
        const r = await fetch(url, {
            method: 'GET',
            headers: { 'Accept': 'application/sparql-results+json' }
        });
        if (r.ok) {
            document.getElementById('statusDot').classList.add('online');
            document.getElementById('statusText').textContent = 'Connected';
        } else throw new Error();
    } catch { 
        document.getElementById('statusText').textContent = 'Offline'; 
    }
}

// â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats() {
    const queries = {
        countInstances: `SELECT (COUNT(DISTINCT ?s) AS ?n) WHERE { GRAPH <${GRAPH_URI}> { ?s a ?t . FILTER(STRSTARTS(STR(?s), "${TEMP_NS}s")) } }`,
        countTriples:   `SELECT (COUNT(*) AS ?n) WHERE { GRAPH <${GRAPH_URI}> { ?s ?p ?o } }`
    };
    for (const [id, q] of Object.entries(queries)) {
        try {
            const url = `${SPARQL_ENDPOINT}?query=${encodeURIComponent(q)}`;
            const r = await fetch(url, {
                method: 'GET',
                headers: { 'Accept': 'application/sparql-results+json' }
            });
            const data = await r.json();
            document.getElementById(id).textContent = data.results.bindings[0]?.n?.value ?? 'â€”';
        } catch {}
    }
}

// â”€â”€ Run query â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runQuery() {
    if (!SPARQL_ENDPOINT) {
        document.getElementById('resultsArea').innerHTML =
            '<div class="error-state">âš  Start Docker and open this page locally to run queries.</div>';
        return;
    }
    const btn = document.getElementById('runBtn');
    const editor = document.getElementById('queryEditor');
    const resultsArea = document.getElementById('resultsArea');
    let query = editor.value.trim();
    if (!query) return;

    const limit = parseInt(document.getElementById('limitInput').value) || 100;
    if (!/LIMIT\s+\d+/i.test(query)) query += `\nLIMIT ${limit}`;

    btn.innerHTML = '<span class="spinner"></span>';
    btn.disabled = true;
    resultsArea.innerHTML = '<div class="empty-state">Executingâ€¦</div>';
    document.getElementById('resultCount').textContent = '';
    document.getElementById('resultTiming').textContent = '';
    document.getElementById('exportBtn').style.display = 'none';

    const t0 = performance.now();
    try {
        const url = `${API_BASE_URL}/sparql?query=${encodeURIComponent(query)}`;
        const r = await fetch(url, {
            method: 'GET',
            headers: { 'Accept': 'application/sparql-results+json' }
        });
        if (!r.ok) throw new Error(`HTTP ${r.status}: ${await r.text()}`);
        const data = await r.json();
        lastResults = data.results.bindings;
        const elapsed = ((performance.now() - t0) / 1000).toFixed(2);
        renderResults(data, elapsed);
        renderGraph(data);
        loadStats();
    } catch (err) {
        resultsArea.innerHTML = `<div class="error-state">âš  Query failed:\n\n${err.message}</div>`;
        document.getElementById('emptyGraph').style.display = 'flex';
        if (g) g.selectAll('*').remove();
    } finally {
        btn.innerHTML = 'â–¶ Run';
        btn.disabled = false;
    }
}

// â”€â”€ Render table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults(data, elapsed) {
    const resultsArea = document.getElementById('resultsArea');
    const vars = data.head.variables;
    const bindings = data.results.bindings;
    lastResults = bindings;

    const count = bindings.length;
    document.getElementById('resultCount').innerHTML = `<span class="count">${count} row${count !== 1 ? 's' : ''}</span>`;
    document.getElementById('resultTiming').innerHTML = `<span class="timing">${elapsed}s</span>`;

    if (count === 0) {
        resultsArea.innerHTML = '<div class="empty-state">No results</div>';
        return;
    }

    document.getElementById('exportBtn').style.display = 'block';

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const hr = document.createElement('tr');
    vars.forEach(v => { const th = document.createElement('th'); th.textContent = v; hr.appendChild(th); });
    thead.appendChild(hr);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    bindings.forEach(row => {
        const tr = document.createElement('tr');
        vars.forEach(v => {
            const td = document.createElement('td');
            const cell = row[v];
            if (!cell) { td.textContent = ''; }
            else if (cell.type === 'uri') { td.className = 'iri'; td.textContent = abbreviate(cell.value); td.title = cell.value; }
            else { td.className = 'literal'; td.textContent = cell.value; }
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    resultsArea.innerHTML = '';
    resultsArea.appendChild(table);
}

// â”€â”€ D3 graph â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initGraph() {
    const container = document.getElementById('graph-container');
    d3.select('#graph-container').selectAll('*').remove();

    svg = d3.select('#graph-container').append('svg')
        .attr('width', '100%').attr('height', '100%');

    zoom = d3.zoom().scaleExtent([0.1, 4])
        .on('zoom', e => { if (g) g.attr('transform', e.transform); });
    svg.call(zoom);

    svg.append('defs').append('marker')
        .attr('id', 'arrow')
        .attr('viewBox', '-0 -5 10 10').attr('refX', 20).attr('refY', 0)
        .attr('orient', 'auto').attr('markerWidth', 6).attr('markerHeight', 6)
        .append('svg:path').attr('d', 'M 0,-5 L 10,0 L 0,5').attr('fill', '#334155');

    g = svg.append('g');

    simulation = d3.forceSimulation()
        .force('link', d3.forceLink().id(d => d.id).distance(180))
        .force('charge', d3.forceManyBody().strength(-1200))
        .force('center', d3.forceCenter(
            container.clientWidth / 2, container.clientHeight / 2))
        .force('collide', d3.forceCollide(70));
}

function renderGraph(data) {
    const vars = data.head.variables;
    const bindings = data.results.bindings;

    // We need at least subject + predicate + object columns to draw a graph
    // Fall back gracefully if result shape doesn't fit
    const sCol = vars[0];
    const pCol = vars[1];
    const oCol = vars[2];

    if (!sCol || !pCol || !oCol) {
        document.getElementById('emptyGraph').style.display = 'flex';
        document.getElementById('emptyGraph').textContent = 'Graph requires 3 columns (subject, predicate, object)';
        if (g) g.selectAll('*').remove();
        return;
    }

    document.getElementById('emptyGraph').style.display = 'none';

    const nodeMap = new Map();
    const links = [];

    const getNode = (cell, role) => {
        if (!cell) return null;
        const id = cell.value;
        if (!nodeMap.has(id)) {
            const isLiteral = cell.type === 'literal' || cell.type === 'typed-literal';
            nodeMap.set(id, {
                id,
                label: isLiteral ? `"${cell.value}"` : abbreviate(cell.value),
                group: isLiteral ? 'literal' : role,
                r: isLiteral ? 10 : (role === 'subject' ? 20 : 14)
            });
        }
        return nodeMap.get(id);
    };

    bindings.forEach(row => {
        const s = row[sCol], p = row[pCol], o = row[oCol];
        if (!s || !p || !o) return;
        getNode(s, 'subject');
        getNode(o, o.type === 'literal' ? 'literal' : 'object');
        links.push({
            source: s.value,
            target: o.value,
            label: abbreviate(p.value)
        });
    });

    const nodes = Array.from(nodeMap.values());
    const COLORS = { subject: '#f59e0b', object: '#38bdf8', literal: '#3b82f6' };

    g.selectAll('*').remove();

    const link = g.append('g').selectAll('line').data(links).enter()
        .append('line').attr('class', 'link').attr('marker-end', 'url(#arrow)');

    const linkLabel = g.append('g').selectAll('g').data(links).enter().append('g');
    linkLabel.append('rect').attr('rx', 3).attr('fill', '#020617').attr('opacity', 0.9);
    linkLabel.append('text').attr('class', 'link-label-text').attr('dy', 3).text(d => d.label);

    const node = g.append('g').selectAll('g').data(nodes).enter().append('g')
        .call(d3.drag()
            .on('start', (e, d) => { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
            .on('drag',  (e, d) => { d.fx = e.x; d.fy = e.y; })
            .on('end',   (e, d) => { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; })
        );

    node.append('circle')
        .attr('r', d => d.r)
        .attr('fill', d => COLORS[d.group] || '#94a3b8')
        .attr('stroke', '#fff').attr('stroke-width', 1);

    const nodeLabel = node.append('g');
    nodeLabel.append('rect').attr('rx', 3).attr('fill', '#020617').attr('opacity', 0.85);
    nodeLabel.append('text').attr('class', 'node-label-text')
        .attr('dy', -25).attr('text-anchor', 'middle').text(d => d.label);

    simulation.nodes(nodes).on('tick', () => {
        link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x).attr('y2', d => d.target.y);

        linkLabel.attr('transform', d =>
            `translate(${(d.source.x + d.target.x) / 2},${(d.source.y + d.target.y) / 2})`);

        linkLabel.each(function() {
            const bbox = d3.select(this).select('text').node().getBBox();
            d3.select(this).select('rect')
                .attr('x', bbox.x - 4).attr('y', bbox.y - 2)
                .attr('width', bbox.width + 8).attr('height', bbox.height + 4);
        });

        node.attr('transform', d => `translate(${d.x},${d.y})`);

        node.selectAll('g').each(function() {
            const bbox = d3.select(this).select('text').node().getBBox();
            d3.select(this).select('rect')
                .attr('x', bbox.x - 4).attr('y', bbox.y - 2)
                .attr('width', bbox.width + 8).attr('height', bbox.height + 4);
        });
    });

    simulation.force('link').links(links);
    simulation.alpha(1).restart();

    // zoom to fit
    setTimeout(() => {
        const bounds = g.node().getBBox();
        const parent = svg.node().parentElement;
        if (bounds.width === 0) return;
        const scale = 0.75 / Math.max(bounds.width / parent.clientWidth, bounds.height / parent.clientHeight);
        const midX = bounds.x + bounds.width / 2;
        const midY = bounds.y + bounds.height / 2;
        svg.transition().duration(750).call(
            zoom.transform,
            d3.zoomIdentity
                .translate(parent.clientWidth / 2 - scale * midX, parent.clientHeight / 2 - scale * midY)
                .scale(scale)
        );
    }, 300);
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function abbreviate(iri) {
    if (iri.startsWith(ONT_NS))  return ':' + iri.slice(ONT_NS.length);
    if (iri.startsWith(TEMP_NS)) return 'temp:' + iri.slice(TEMP_NS.length);
    if (iri.startsWith('http://www.w3.org/1999/02/22-rdf-syntax-ns#')) return 'rdf:' + iri.slice(43);
    if (iri.startsWith('http://www.w3.org/2000/01/rdf-schema#')) return 'rdfs:' + iri.slice(37);
    return iri;
}

function exportCSV() {
    if (!lastResults.length) return;
    const vars = Object.keys(lastResults[0]);
    const rows = [vars.join(',')];
    lastResults.forEach(row => {
        rows.push(vars.map(v => `"${(row[v]?.value || '').replace(/"/g, '""')}"`).join(','));
    });
    const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'sparql-results.csv';
    a.click();
}
</script>
</body>
</html>